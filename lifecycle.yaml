---
version: '1.0.0'

environment:
  autoDeploy: true
  defaultServices:
    - name: 'backend-cache'
    - name: 'backend-svc'
  optionalServices:
    - name: 'backend-optional-cache'
  webhooks:
    - state: 'deployed'
      type: 'codefresh'
      name: 'lfc: deployed'
      description: 'Lifecycle deployed webhook'
      pipelineId: '6716ee061897917c1bf1ab5c'
      trigger: 'deploy-lfc'
      env:
        branch: 'main'   
        ENV: 'lifecycle'
    
services:
  - name: "backend-svc"
    helm:
      repository: "vigneshrajsb/backend-svc"
      branchName: "main"
      grpc: true
      chart:
        name: 'goodrx-app'
        valueFiles:
          - 'sysops/helm/common.yaml'
          - 'sysops/helm/lfc/service/grpc-service.yaml'
      docker:
        defaultTag: "main"
        app:
          dockerfilePath: "backend-svc/Dockerfile"
          ports:
            - 8080
          env:
            COMPONENT: "app"
            ENV: "lifecycle"
            CACHE_SIMPLE: "{{{backend-cache_internalHostname}}}"
            CACHE_HOST: "{{backend-cache_internalHostname}}-master"
            CACHE_URL: "{{{backend-cache_internalHostname}}}:6379"
            CACHE_ME: "{{{backend-cache_internalHostname}}}-master:6379"
            DEFAULT_SIMPLE: "{{{backend-default_internalHostname}}}"
            DEFAULT_HOST: "{{{backend-default_internalHostname}}}-master"
            DEFAULT_URL: "{{backend-default_internalHostname}}:6379"
            DEFAULT_ME: "{{{backend-default_internalHostname}}}-master:6379"
            OPT_CACHE_SIMPLE: "{{{backend-optional-cache_internalHostname}}}"
            OPT_CACHE_HOST: "{{{backend-optional-cache_internalHostname}}}-master"
            OPT_CACHE_URL: "{{{backend-optional-cache_internalHostname}}}:6379"
            OPT_CACHE_ME: "{{backend-optional-cache_internalHostname}}-master:6379"
            TEST: "other"
            BUILD_UUID: '{{{backend-cache_buildUUID}}}'
            OPT_BUILD_UUID: '{{backend-optional-cache_buildUUID}}'
            PUBLIC_URL: '{{backend-cache_publicUrl}}'
            OPT_PUBLIC_URL: '{{{backend-optional-cache_publicUrl}}}'
            UUID: '{{{ backend-cache_UUID }}}'
            OPT_UUID: '{{{ backend-optional-cache_UUID }}}'

  - name: "backend-cache"
    helm:
      repository: "vigneshrajsb/backend-svc"
      branchName: "main"
      chart:
        name: "redis"
        version: 20.3.0
        repoUrl: "https://charts.bitnami.com/bitnami"
        values:
          - "master.pdb.create=true"
          - "master.pdb.minAvailable=50%"
          - "master.count=2"

  - name: "backend-optional-cache"
    helm:
      repository: "vigneshrajsb/backend-svc"
      branchName: "main"
      chart:
        name: "redis"
        version: 20.3.0
        repoUrl: "https://charts.bitnami.com/bitnami"
        values:
          - "master.pdb.create=true"
          - "master.pdb.minAvailable=50%"
          - "master.count=2"
